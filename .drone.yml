kind: pipeline
name: build-test-and-publish

steps:
- name: build-test-and-publish
  image: mcr.microsoft.com/dotnet/sdk:6.0
  environment:
    NUGET_SERVER_ADRESS:
      from_secret: NUGET_SERVER_ADRESS
    NUGET_SERVER_KEY:
      from_secret: NUGET_SERVER_KEY
  commands:
    - sed -i 's/>1.0.0</>${DRONE_TAG}</g' Dysnomia.Common.SteamWebAPI/Dysnomia.Common.SteamWebAPI.csproj
    - dotnet build Dysnomia.Common.SteamWebAPI.sln -c Release
    - dotnet pack Dysnomia.Common.SteamWebAPI.sln -c Release
    - dotnet nuget push -s $NUGET_SERVER_ADRESS -k $NUGET_SERVER_KEY $(ls /drone/src/Dysnomia.Common.SteamWebAPI/bin/Release/*.nupkg | head -1)
  when:
    event:
    - tag

- name: docker
  image: plugins/docker
  settings:
    repo: dysnomia/dysnomia-common-steamwebapi
    dockerfile: Dockerfile
    tags: ${DRONE_BRANCH//\//-}
    dry_run: true
    pull-image: false
  environment:
    PLUGIN_PULL_IMAGE: false
    DRONE_BRANCH: ${DRONE_BRANCH}
    PUBLISHER_KEY: 
      from_secret: PUBLISHER_KEY
    SONAR_HOST: 
      from_secret: SONAR_HOST
    SONAR_TOKEN: 
      from_secret: SONAR_TOKEN
    STEAMID: 
      from_secret: STEAMID
    WEBAPI_KEY: 
      from_secret: WEBAPI_KEY
  settings:
    build_args_from_env:
      - DRONE_BRANCH
      - PUBLISHER_KEY
      - SONAR_HOST
      - SONAR_TOKEN
      - STEAMID
      - WEBAPI_KEY
  when:
    event:
    - push

- name: discord
  pull: default
  image: appleboy/drone-discord
  settings:
    webhook_id:
      from_secret: WEBHOOK_ID
    webhook_token:
      from_secret: WEBHOOK_TOKEN
    message: >
      {{#success build.status}}
        Build **{{repo.name}}** for tag **${DRONE_TAG}** succeeded.
      {{else}}
        Build **{{repo.name}}** for tag **${DRONE_TAG}** failed.
      {{/success}}
  when:
    status: 
    - changed
    - failure
    - success
